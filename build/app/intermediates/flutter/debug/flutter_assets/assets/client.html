<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
    <h1>Discution</h1>
    <div>
      <label for="nameInput">Mon pseudo :</label>
      <input type="text" id="nameInput" />
      <button onclick="setPseudo()">Appliquer</button>
    </div>
    <div id="messages"></div>
    <input type="text" id="messageInput" />
    <button onclick="sendMessage()">Envoyer</button>
    <script>
      var xhr; // Declare xhr outside of the functions to make it accessible to both

      function getMessages() {
        xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              // Si la réponse est OK, afficher les messages
              var response = JSON.parse(xhr.responseText);
              var messages = response["messages"];
              var messagesHtml = "";
              for (var i = 0; i < messages.length; i++) {
                messagesHtml +=
                  // "<p><strong>Client: </strong>" +
                  // clients[i] +
                  "<br><strong>Message: </strong>" +
                  messages[i].message +
                  "</p>";
              }
              document.getElementById("messages").innerHTML = messagesHtml;
            } else {
              // Si la réponse n'est pas OK, afficher l'erreur
              document.getElementById("messages").innerHTML =
                "<p>Erreur: " + xhr.responseText + "</p>";
            }
          }
        };
        xhr.open("GET", "/?type=html", true);
        xhr.send();
      }

      function requestPost(type) {
        xhr = new XMLHttpRequest();
        xhr.open("POST", "/", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        let dataJson;
        if (type == "message") {
          // message
          var message = document.getElementById("messageInput").value;
          dataJson = { type: "message", message: message };
          document.getElementById("messageInput").value = "";
        } else if (type == "init") {
          // init
          const randomString = generateRandomString(10);
          const inputElement = document.getElementById("nameInput");
          inputElement.value = randomString;
          dataJson = { type: "init", pseudo: randomString };
        } else {
          // pseudo
          var pseudo = document.getElementById("nameInput").value;
          dataJson = { type: "pseudo", pseudo: pseudo };
        }
        xhr.send(JSON.stringify(dataJson));
      }

      function generateRandomString(length) {
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let randomString = "";
        for (let i = 0; i < length; i++) {
          randomString += characters.charAt(getRandomInt(0, characters.length));
        }
        return randomString;
      }

      function setInitMe() {
        requestPost("init");
      }
      function setPseudo() {
        requestPost("pseudo");
      }

      function sendMessage() {
        requestPost("message");
      }

      // set random pseudo
      setInitMe();

      getMessages(); // Initial call to getMessages function
      setInterval(getMessages, 1000); // Call getMessages function every second
    </script>
  </body>
</html>
